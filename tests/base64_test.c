/*
 * Copyright (c) 2012 Kyle Isom <kyle@tyrfingr.is>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
 * WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
 * AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
 * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA
 * OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
 * TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
 * PERFORMANCE OF THIS SOFTWARE.
 * ---------------------------------------------------------------------
 */


#include <sys/types.h>
#include <CUnit/CUnit.h>
#include <CUnit/Basic.h>
#include <err.h>
#include <stdlib.h>
#include <sysexits.h>


void test_base64_enclen(void);


/*
 * Stubs required by the test suite, but for which no functionality is
 * required in this code. init_test is called each time a test is run,
 * and cleanup is run after every test.
 */
int init_test(void)
{
        return 0;
}

int cleanup_test(void)
{
        return 0;
}


/*
 * fireball is the code called when adding test fails: cleanup the test
 * registry and exit.
 */
void
fireball(void)
{
        CU_cleanup_registry();
        exit(CU_get_error());
}


/*
 * The main function sets up the test suite, registers the test cases,
 * runs through them, and hopefully doesn't explode.
 */
int
main(void)
{
        CU_pSuite       tsuite = NULL;
        unsigned int    fails;

        if (!(CUE_SUCCESS == CU_initialize_registry())) {
                errx(EX_CONFIG, "failed to initialise test registry");
                return EXIT_FAILURE;
        }

        tsuite = CU_add_suite(TEST_SUITE, init_test, cleanup_test);
        if (NULL == tsuite)
                fireball();

        if (NULL == CU_add_test(tsuite, "base64 encoding length",
                                test_base64_enclen))
                fireball();

        CU_basic_set_mode(CU_BRM_VERBOSE);
        CU_basic_run_tests();
        fails = CU_get_number_of_tests_failed();
        warnx("%u tests failed", fails);

        CU_cleanup_registry();
        return fails;
}


/*
 * This is an empty test provided for reference.
 */
void
test_base64_enclen()
{
        size_t  i = 0;
        size_t  test_vec[] = {0, 4, 8, 12, 20, 24, 28, 36, 40, 44, 52,
                              56, 60, 68, 72, 76, 85, 89, 93, 101, 105,
                              113, 121, 125, 133, 141, 145, 153, 162, 166,
                              174, 182, 186, 194, 202, 206, 214, 222, 226,
                              235, 243, 247, 255, 263, 267, 275, 283,
                              287, 295, 303, 307, 316, 324, 328, 336,
                              344, 348, 356, 364, 368, 376, 384, 389,
                              397, 405, 409, 417, 425, 429, 437, 445,
                              449, 457, 466, 470, 478, 486, 490, 498,
                              506, 510, 518, 526, 530, 538, 547, 551,
                              559, 567, 571, 579, 587, 591, 599, 607,
                              611, 620, 628, 632, 640, 648, 652, 660,
                              668, 672, 680, 688, 692, 701, 709, 713,
                              721, 729, 733, 741, 749, 753, 761, 769,
                              774, 782, 790, 794, 802, 810, 814, 822,
                              830, 834, 842, 851, 855, 863, 871, 875,
                              883, 891, 895, 903, 911, 915, 923, 932,
                              936, 944, 952, 956, 964, 972, 976, 984,
                              992, 996, 1005, 1013, 1021, 1029, 1037,
                              1045, 1053, 1061, 1069, 1077, 1086, 1094,
                              1102, 1110, 1118, 1126, 1134, 1142, 1150,
                              1159, 1167, 1175, 1183, 1191, 1199, 1207,
                              1215, 1223, 1231, 1240, 1248, 1256, 1264,
                              1272, 1280, 1288, 1296, 1304, 1313, 1321,
                              1329, 1337, 1345, 1353, 1361, 1369, 1377,
                              1385, 1394, 1402, 1410, 1418, 1426, 1434,
                              1442, 1450, 1458, 1467, 1475, 1483, 1491,
                              1499, 1507, 1515, 1523, 1531, 1539, 1548,
                              1556, 1564, 1572, 1580, 1588, 1596, 1604,
                              1612, 1621, 1629, 1637, 1645, 1653, 1661,
                              1669, 1677, 1685, 1693, 1702, 1710, 1718,
                              1726, 1734, 1742, 1750, 1758, 1766, 1775,
                              1783, 1791, 1799, 1807, 1815, 1823, 1831,
                              1839, 1847, 1856, 1864, 1872, 1880, 1888,
                              1896, 1904, 1912, 1920, 1929, 1937, 1945,
                              1953, 1961, 1969, 1977, 1985, 1993, 2001,
                              2010, 2018, 2026, 2034, 2042, 2050, 2058,
                              2066, 2074, 2083, 2091, 2099, 2107, 2115,
                              2123, 2131, 2139, 2147, 2155, 2164, 2172,
                              2180, 2188, 2196, 2204, 2212, 2220, 2228,
                              2237, 2245, 2253, 2261, 2269, 2277, 2285,
                              2293, 2301, 2309, 2318, 2326, 2334, 2342,
                              2350, 2358, 2366, 2374, 2382, 2391, 2399,
                              2407, 2415, 2423, 2431, 2439, 2447, 2455,
                              2463, 2472, 2480, 2488, 2496, 2504, 2512,
                              2520, 2528, 2536, 2545, 2553, 2561, 2569,
                              2577, 2585, 2593, 2601, 2609, 2617, 2626,
                              2634, 2642, 2650, 2658, 2666, 2674, 2682,
                              2690, 2699, 2707, 2715, 2723, 2731, 2739,
                              2747, 2755, 2763, 2771, 2780, 2788, 2796,
                              2804, 2812, 2820, 2828, 2836, 2844, 2853,
                              2861, 2869, 2877, 2885, 2893, 2901, 2909,
                              2917, 2925, 2934, 2942, 2950, 2958, 2966,
                              2974, 2982, 2990, 2998, 3007, 3015, 3023,
                              3031, 3039, 3047, 3055, 3063, 3071, 3079,
                              3088, 3096, 3104, 3112, 3120, 3128, 3136,
                              3144, 3152, 3161, 3169, 3177, 3185, 3193,
                              3201, 3209, 3217, 3225, 3233, 3242, 3250,
                              3258, 3266, 3274, 3282, 3290, 3298, 3306,
                              3315, 3323, 3331, 3339, 3347, 3355, 3363,
                              3371, 3379, 3387, 3396, 3404, 3412, 3420,
                              3428, 3436, 3444, 3452, 3460, 3469, 3477,
                              3485, 3493, 3501, 3509, 3517, 3525, 3533,
                              3541, 3550, 3558, 3566, 3574, 3582, 3590,
                              3598, 3606, 3614, 3623, 3631, 3639, 3647,
                              3655, 3663, 3671, 3679, 3687, 3695, 3704,
                              3712, 3720, 3728, 3736, 3744, 3752, 3760,
                              3768, 3777, 3785, 3793, 3801, 3809, 3817,
                              3825, 3833, 3841, 3849, 3858, 3866, 3874,
                              3882, 3890, 3898, 3906, 3914, 3922, 3931,
                              3939, 3947, 3955, 3963, 3971, 3979, 3987,
                              3995, 4003, 4012, 4020, 4028, 4036, 4044,
                              4052, 4060, 4068, 4076, 4085, 4093, 4101,
                              4109, 4117, 4125, 4133, 4141, 4149, 4157,
                              4166, 4174, 4182, 4190, 4198, 4206, 4214,
                              4222, 4230, 4239, 4247, 4255, 4263, 4271,
                              4279, 4287, 4295, 4303, 4311, 4320, 4328,
                              4336, 4344, 4352, 4360, 4368, 4376, 4384,
                              4393, 4401, 4409, 4417, 4425, 4433, 4441,
                              4449, 4457, 4465, 4474, 4482, 4490, 4498,
                              4506, 4514, 4522, 4530, 4538, 4547, 4555,
                              4563, 4571, 4579, 4587, 4595, 4603, 4611,
                              4619, 4628, 4636, 4644, 4652, 4660, 4668,
                              4676, 4684, 4692, 4701, 4709, 4717, 4725,
                              4733, 4741, 4749, 4757, 4765, 4773, 4782,
                              4790, 4798, 4806, 4814, 4822, 4830, 4838,
                              4846, 4855, 4863, 4871, 4879, 4887, 4895,
                              4903, 4911, 4919, 4927, 4936, 4944, 4952,
                              4960, 4968, 4976, 4984, 4992, 5000, 5009,
                              5017, 5025, 5033, 5041, 5049, 5057, 5065,
                              5073, 5081, 5090, 5098, 5106, 5114, 5122,
                              5130, 5138, 5146, 5154, 5163, 5171, 5179,
                              5187, 5195, 5203, 5211, 5219, 5227, 5235,
                              5244, 5252, 5260, 5268, 5276, 5284, 5292,
                              5300, 5308, 5317, 5325, 5333, 5341, 5349,
                              5357, 5365, 5373, 5381, 5389, 5398, 5406,
                              5414, 5422, 5430, 5438, 5446, 5454, 5462,
                              5471, 5479, 5487, 5495, 5503, 5511, 5519,
                              5527, 5535, 5543, 5552, 5560, 5568, 5576,
                              5584, 5592, 5600, 5608, 5616, 5625, 5633,
                              5641, 5649, 5657, 5665, 5673, 5681, 5689,
                              5697, 5706, 5714, 5722, 5730, 5738, 5746,
                              5754, 5762, 5770, 5779, 5787, 5795, 5803,
                              5811, 5819, 5827, 5835, 5843, 5851, 5860,
                              5868, 5876, 5884, 5892, 5900, 5908, 5916,
                              5924, 5933, 5941, 5949, 5957, 5965, 5973,
                              5981, 5989, 5997, 6005, 6014, 6022, 6030,
                              6038, 6046, 6054, 6062, 6070, 6078, 6087,
                              6095, 6103, 6111, 6119, 6127, 6135, 6143,
                              6151, 6159, 6168, 6176, 6184, 6192, 6200,
                              6208, 6216, 6224, 6232, 6241, 6249, 6257,
                              6265, 6273, 6281, 6289, 6297, 6305, 6313,
                              6322, 6330, 6338, 6346, 6354, 6362, 6370,
                              6378, 6386, 6395, 6403, 6411, 6419, 6427,
                              6435, 6443, 6451, 6459, 6467, 6476, 6484,
                              6492, 6500, 6508, 6516, 6524, 6532, 6540,
                              6549, 6557, 6565, 6573, 6581, 6589, 6597,
                              6605, 6613, 6621, 6630, 6638, 6646, 6654,
                              6662, 6670, 6678, 6686, 6694, 6703, 6711,
                              6719, 6727, 6735, 6743, 6751, 6759, 6767,
                              6775, 6784, 6792, 6800, 6808, 6816, 6824,
                              6832, 6840, 6848, 6857, 6865, 6873, 6881,
                              6889, 6897, 6905, 6913, 6921, 6929, 6938,
                              6946, 6954, 6962, 6970, 6978, 6986, 6994,
                              7002, 7011, 7019, 7027, 7035, 7043, 7051,
                              7059, 7067, 7075, 7083, 7092, 7100, 7108,
                              7116, 7124, 7132, 7140, 7148, 7156, 7165,
                              7173, 7181, 7189, 7197, 7205, 7213, 7221,
                              7229, 7237, 7246, 7254, 7262, 7270, 7278,
                              7286, 7294, 7302, 7310, 7319, 7327, 7335,
                              7343, 7351, 7359, 7367, 7375, 7383, 7391,
                              7400, 7408, 7416, 7424, 7432, 7440, 7448,
                              7456, 7464, 7473, 7481, 7489, 7497, 7505,
                              7513, 7521, 7529, 7537, 7545, 7554, 7562,
                              7570, 7578, 7586, 7594, 7602, 7610, 7618,
                              7627, 7635, 7643, 7651, 7659, 7667, 7675,
                              7683, 7691, 7699, 7708, 7716, 7724, 7732,
                              7740, 7748, 7756, 7764, 7772, 7781, 7789,
                              7797, 7805, 7813, 7821, 7829, 7837, 7845,
                              7853, 7862, 7870, 7878, 7886, 7894, 7902,
                              7910, 7918, 7926, 7935, 7943, 7951, 7959,
                              7967, 7975, 7983, 7991, 7999, 8007, 8016,
                              8024, 8032, 8040, 8048, 8056, };
        for (i = 0; i < 1024; i++)
                CU_ASSERT(base64_enclen(i) == test_vec[i]);
}
